phina.namespace(function(){phina.define("phina.particle2dx.ColoredTexture",{superClass:"phina.graphics.Canvas",orig:null,r:-1,g:-1,b:-1,_textureName:null,_domElementBackup:null,init:function(t){this.superInit(),this.orig=phina.asset.AssetManager.get("image",t.textureName),this.setSize(this.orig.domElement.width,this.orig.domElement.height),this._textureName=t.textureName,this._canvasForCache=Array.range(0,1e3).map(function(){return phina.graphics.Canvas().setSize(this.width,this.height)}.bind(this)),this.setColor(1,1,1)},setColor:function(t,i,e){const a=1*~~(256*t),n=1*~~(256*i),s=1*~~(256*e);if(this.r===a&&this.g===n&&this.b===s)return;this.r=a,this.g=n,this.b=s;const r="{_textureName},{r},{g},{b}".format(this),o=phina.particle2dx.ColoredTexture._cache;if(o[r])this._domElementBackup||(this._domElementBackup=this.domElement),this.domElement=o[r].domElement;else{this._domElementBackup&&(this.domElement=this._domElementBackup);const t=this.context;t.clearRect(0,0,this.width,this.height),t.globalCompositeOperation="source-over",t.drawImage(this.orig.domElement,0,0),t.globalCompositeOperation="source-in",t.fillStyle="rgb({r},{g},{b})".format(this),t.fillRect(0,0,this.width,this.height);const i=this._canvasForCache.length?this._canvasForCache.shift():phina.graphics.Canvas().setSize(this.width,this.height);i.context.drawImage(this.domElement,0,0),o[r]=i}},_static:{_cache:{}}})}),phina.namespace(function(){phina.define("phina.particle2dx.Emitter",{superClass:"phina.app.Object2D",active:!1,random:null,particles:null,emitCount:0,emitPerMillisec:0,init:function(t){this.superInit(t),t={}.$safe(t,phina.particle2dx.Emitter.defaults),this.random=phina.util.Random(),this._initProperties(t),this._initParticles(t),this.emitPerMillisec=this.maxParticles/(1e3*this.particleLifespan)},_initProperties:function(t){var i=phina.asset.AssetManager.get("json",t.jsonName).data;this.duration=i.duration,this.emitterType=i.emitterType,this.particleLifespan=i.particleLifespan,this.particleLifespanVariance=i.particleLifespanVariance,this.maxParticles=i.maxParticles,this.angle=i.angle,this.angleVariance=i.angleVariance,this.speed=i.speed,this.speedVariance=i.speedVariance,this.sourcePositionVariancex=i.sourcePositionVariancex,this.sourcePositionVariancey=i.sourcePositionVariancey,this.gravityx=i.gravityx,this.gravityy=i.gravityy,this.radialAcceleration=i.radialAcceleration,this.radialAccelVariance=i.radialAccelVariance,this.tangentialAcceleration=i.tangentialAcceleration,this.tangentialAccelVariance=i.tangentialAccelVariance,this.maxRadius=i.maxRadius,this.maxRadiusVariance=i.maxRadiusVariance,this.minRadius=i.minRadius,this.minRadiusVariance=i.minRadiusVariance,this.rotatePerSecond=i.rotatePerSecond,this.rotatePerSecondVariance=i.rotatePerSecondVariance,this.blendFuncDestination=i.blendFuncDestination,this.blendFuncSource=i.blendFuncSource,this.startParticleSize=i.startParticleSize,this.startParticleSizeVariance=i.startParticleSizeVariance,-1==i.finishParticleSize?this.finishParticleSize=this.startParticleSize:this.finishParticleSize=i.finishParticleSize,this.finishParticleSizeVariance=i.finishParticleSizeVariance,this.rotationStart=i.rotationStart,this.rotationStartVariance=i.rotationStartVariance,this.rotationEnd=i.rotationEnd,this.rotationEndVariance=i.rotationEndVariance,this.startColorRed=i.startColorRed,this.startColorGreen=i.startColorGreen,this.startColorBlue=i.startColorBlue,this.startColorAlpha=i.startColorAlpha,this.startColorVarianceRed=i.startColorVarianceRed,this.startColorVarianceGreen=i.startColorVarianceGreen,this.startColorVarianceBlue=i.startColorVarianceBlue,this.startColorVarianceAlpha=i.startColorVarianceAlpha,this.finishColorRed=i.finishColorRed,this.finishColorGreen=i.finishColorGreen,this.finishColorBlue=i.finishColorBlue,this.finishColorAlpha=i.finishColorAlpha,this.finishColorVarianceRed=i.finishColorVarianceRed,this.finishColorVarianceGreen=i.finishColorVarianceGreen,this.finishColorVarianceBlue=i.finishColorVarianceBlue,this.finishColorVarianceAlpha=i.finishColorVarianceAlpha},_initParticles:function(t){this.particles=Array.range(0,this.maxParticles).map(function(i){var e=this._createParticle(t.textureName,i);return e.on("removed",function(){e.visible=!1,this.particles.push(e)}.bind(this)),e}.bind(this))},_createParticle:function(t,i){throw"no impl"},_createParticleAccessory:function(){return phina.particle2dx.Particle()},start:function(){return this.active=!0,this.duration>0&&this.tweener.clear().wait(1e3*this.duration).set({active:!1}),this},stop:function(){return this.active=!1,this},update:function(t){if(this.active){this.emitCount+=this.emitPerMillisec*t.deltaTime;for(var i=0;i<~~this.emitCount;i++)this.emit();this.emitCount-=~~this.emitCount}},emit:function(){var t=this.particles.shift();if(t){t.addChildTo(this.parent);var i=this.random,e=t.particle;e.life=this.particleLifespan+i.randfloat(-this.particleLifespanVariance,this.particleLifespanVariance),e.emitterType=this.emitterType,e.emitterPosition.set(this.x,this.y);var a=this.startParticleSize+i.randfloat(-this.startParticleSizeVariance,this.startParticleSizeVariance),n=this.finishParticleSize+i.randfloat(-this.finishParticleSizeVariance,this.finishParticleSizeVariance),s=this.rotationStart+i.randfloat(-this.rotationStartVariance,this.rotationStartVariance),r=this.rotationEnd+i.randfloat(-this.rotationEndVariance,this.rotationEndVariance),o=this.startColorRed+i.randfloat(-this.startColorVarianceRed,this.startColorVarianceRed),h=this.finishColorRed+i.randfloat(-this.finishColorVarianceRed,this.finishColorVarianceRed),c=this.startColorGreen+i.randfloat(-this.startColorVarianceGreen,this.startColorVarianceGreen),l=this.finishColorGreen+i.randfloat(-this.finishColorVarianceGreen,this.finishColorVarianceGreen),d=this.startColorBlue+i.randfloat(-this.startColorVarianceBlue,this.startColorVarianceBlue),u=this.finishColorBlue+i.randfloat(-this.finishColorVarianceBlue,this.finishColorVarianceBlue),p=this.startColorAlpha+i.randfloat(-this.startColorVarianceAlpha,this.startColorVarianceAlpha),m=this.finishColorAlpha+i.randfloat(-this.finishColorVarianceAlpha,this.finishColorVarianceAlpha);if(0===this.emitterType){e.position.x=this.x+i.randfloat(-this.sourcePositionVariancex,this.sourcePositionVariancex),e.position.y=this.y+i.randfloat(-this.sourcePositionVariancey,this.sourcePositionVariancey);var f=(this.angle+i.randfloat(-this.angleVariance,this.angleVariance)).toRadian(),g=this.speed+i.randfloat(-this.speedVariance,this.speedVariance);e.velocity.set(Math.cos(f)*g,-Math.sin(f)*g),e.gravity.set(this.gravityx,this.gravityy),e.initRadialAccel(this.radialAcceleration+i.randfloat(-this.radialAccelVariance,this.radialAccelVariance)),e.tangentialAccel=this.tangentialAcceleration+i.randfloat(-this.tangentialAccelVariance,this.tangentialAccelVariance),e.set({sizeFrom:a,sizeTo:n,rotationFrom:s,rotationTo:r,rFrom:o,rTo:h,gFrom:c,gTo:l,bFrom:d,bTo:u,aFrom:p,aTo:m})}else if(1===this.emitterType){e.posAngle=this.angle+i.randfloat(-this.angleVariance,this.angleVariance);var x=this.maxRadius+i.randfloat(-this.maxRadiusVariance,this.maxRadiusVariance),v=this.minRadius+i.randfloat(-this.minRadiusVariance,this.minRadiusVariance);e.rotPerSec=(this.rotatePerSecond+i.randfloat(-this.rotatePerSecondVariance,this.rotatePerSecondVariance)).toRadian(),e.set({sizeFrom:a,sizeTo:n,rotationFrom:s,rotationTo:r,rFrom:o,rTo:h,gFrom:c,gTo:l,bFrom:d,bTo:u,aFrom:p,aTo:m,radiusFrom:x,radiusTo:v})}e.update({deltaTime:0})}},_static:{defaults:{jsonName:null,textureName:null}}})}),phina.namespace(function(){phina.define("phina.particle2dx.EmitterGL",{superClass:"phina.particle2dx.Emitter",gl:null,texture:null,init:function(t){this.superInit(t),this.textureName=t.textureName},_initParticles:function(t){this.oneInstanceData=[0,0,0,0,1,0,0,0,0];var i=Array.range(0,this.maxParticles).map(function(){return this.oneInstanceData}.bind(this)).flatten();this.instanceData=new Float32Array(i),this.superMethod("_initParticles",t)},_createParticle:function(t,i){var e=phina.particle2dx.ParticleGL(this,i);return e.particle=this._createParticleAccessory().attachTo(e),e},setup:function(t){var i=t.gl,e=t.ext;t.vpMatrix;return this.texture=phigl.Texture(i,this.textureName),this.drawable=phigl.InstancedDrawable(i,e).setProgram(this._createProgram(i)).setIndexValues([0,1,2,2,1,3]).declareAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-.5,.5,-.5,-.5,.5,.5,.5,-.5]},{unitSize:2,data:[0,1,0,0,1,1,1,0]}]).declareInstanceAttributes(["instanceVisible","instancePosition","instanceRotation","instanceScale","instanceColor"]).declareUniforms("vpMatrix","texture"),this},render:function(t){var i=t.gl;1===this.blendFuncDestination?(i.blendFuncSeparate(i.SRC_ALPHA,i.ONE,i.ONE,i.ONE),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD)):771===this.blendFuncDestination&&(i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD)),this.drawable.uniforms.vpMatrix.setValue(t.vpMatrix),this.drawable.uniforms.texture.setValue(0).setTexture(this.texture),this.drawable.setInstanceAttributeData(this.instanceData),this.drawable.draw(this.maxParticles)},_createProgram:function(t){var i=phina.particle2dx.EmitterGL.vertexShaderSource,e=phina.particle2dx.EmitterGL.fragmentShaderSource;return phigl.Program(t).attach(phigl.VertexShader().setSource(i)).attach(phigl.FragmentShader().setSource(e)).link()},_static:{vertexShaderSource:["attribute vec2 position;","attribute vec2 uv;","attribute float instanceVisible;","attribute vec2 instancePosition;","attribute float instanceRotation;","attribute float instanceScale;","attribute vec4 instanceColor;","uniform mat4 vpMatrix;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","  vUv = uv;","  vColor = instanceColor;","  if (instanceVisible > 0.5) {","    float s = sin(-instanceRotation);","    float c = cos(-instanceRotation);","    mat4 m = mat4(","      vec4(c, -s, 0.0, 0.0),","      vec4(s, c, 0.0, 0.0),","      vec4(0.0, 0.0, 1.0, 0.0),","      vec4(instancePosition, 0.0, 1.0)","    ) * mat4(","      vec4(instanceScale, 0.0, 0.0, 0.0),","      vec4(0.0, instanceScale, 0.0, 0.0),","      vec4(0.0, 0.0, 1.0, 0.0),","      vec4(0.0, 0.0, 0.0, 1.0)","    );","    mat4 mvpMatrix = vpMatrix * m;","    gl_Position = mvpMatrix * vec4(position, 0.0, 1.0);","  } else {","    gl_Position = vec4(0.0);","  }","}"].join("\n"),fragmentShaderSource:["precision mediump float;","uniform sampler2D texture;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","  vec4 col = texture2D(texture, vUv);","  if (col.a == 0.0) discard;","  gl_FragColor = col * vColor;","}"].join("\n")}}),phina.define("phina.particle2dx.ParticleGL",{superClass:"phina.app.Element",oneDataLength:0,instanceData:null,index:0,init:function(t,i){this.superInit(),this.oneDataLength=t.oneInstanceData.length,this.instanceData=t.instanceData,this.index=i},_accessor:{visible:{get:function(){return!!this.instanceData[this.oneDataLength*this.index+0]},set:function(t){this.instanceData[this.oneDataLength*this.index+0]=t?1:0}},x:{get:function(){return this.instanceData[this.oneDataLength*this.index+1]},set:function(t){this.instanceData[this.oneDataLength*this.index+1]=t}},y:{get:function(){return this.instanceData[this.oneDataLength*this.index+2]},set:function(t){this.instanceData[this.oneDataLength*this.index+2]=t}},rotation:{get:function(){return this.instanceData[this.oneDataLength*this.index+3]},set:function(t){this.instanceData[this.oneDataLength*this.index+3]=t}},scale:{get:function(){return this.instanceData[this.oneDataLength*this.index+4]},set:function(t){this.instanceData[this.oneDataLength*this.index+4]=t}},r:{get:function(){return this.instanceData[this.oneDataLength*this.index+5]},set:function(t){this.instanceData[this.oneDataLength*this.index+5]=t}},g:{get:function(){return this.instanceData[this.oneDataLength*this.index+6]},set:function(t){this.instanceData[this.oneDataLength*this.index+6]=t}},b:{get:function(){return this.instanceData[this.oneDataLength*this.index+7]},set:function(t){this.instanceData[this.oneDataLength*this.index+7]=t}},a:{get:function(){return this.instanceData[this.oneDataLength*this.index+8]},set:function(t){this.instanceData[this.oneDataLength*this.index+8]=t}}}})}),phina.namespace(function(){phina.define("phina.particle2dx.Particle",{superClass:"phina.accessory.Accessory",emitterType:0,r:1,g:1,b:1,a:1,emitterPosition:null,life:0,position:null,velocity:null,gravity:null,radialAccel:null,tangentialAccel:0,_tangentialAccel:null,posAngle:0,rotPerSec:0,init:function(){this.superInit(),this.position=phina.geom.Vector2(),this.velocity=phina.geom.Vector2(),this.gravity=phina.geom.Vector2(),this.radialAccel=phina.geom.Vector2(),this.emitterPosition=phina.geom.Vector2(),this._tangentialAccel=phina.geom.Vector2()},initRadialAccel:function(t){this.radialAccel.set(this.position.x-this.emitterPosition.x,this.position.y-this.emitterPosition.y).normalize().mul(t)},set:function(t){var i=1e3*this.life,e=this.target;e.visible=!0,0===this.emitterType?(e.$extend({scale:t.sizeFrom,rotation:t.rotationFrom,r:t.rFrom,g:t.gFrom,b:t.bFrom,a:t.aFrom}),e.tweener.clear().to({scale:t.sizeTo,rotation:t.rotationTo,r:t.rTo,g:t.gTo,b:t.bTo,a:t.aTo},i).call(function(){e.remove()})):1===this.emitterType&&(e.$extend({scale:t.sizeFrom,rotation:t.rotationFrom,r:t.rFrom,g:t.gFrom,b:t.bFrom,a:t.aFrom,posRadius:t.radiusFrom}),e.tweener.clear().to({scale:t.sizeTo,rotation:t.rotationTo,r:t.rTo,g:t.gTo,b:t.bTo,a:t.aTo,posRadius:t.radiusTo},i).call(function(){e.remove()}))},update:function(i){var e=.001*i.deltaTime;0===this.emitterType?(t(this.velocity,this.gravity,e),t(this.velocity,this.radialAccel,e),this.tangentialAccel&&(this._tangentialAccel.set(this.position.x-this.emitterPosition.x,this.position.y-this.emitterPosition.y),this._tangentialAccel.set(-this._tangentialAccel.y,this._tangentialAccel.x).normalize().mul(this.tangentialAccel),t(this.velocity,this._tangentialAccel,e)),t(this.position,this.velocity,e)):1===this.emitterType&&(this.posAngle-=this.rotPerSec*e,this.position.set(this.emitterPosition.x+Math.cos(this.posAngle)*this.target.posRadius,this.emitterPosition.y-Math.sin(this.posAngle)*this.target.posRadius)),this.target.x=this.position.x,this.target.y=this.position.y}});var t=function(t,i,e){t.x+=i.x*e,t.y-=i.y*e}}),phina.namespace(function(){phina.define("phina.particle2dx.ParticleCanvas",{superClass:"phina.display.Sprite",particle:null,init:function(t){this.superInit(t),this.particle=phina.particle2dx.Particle().attachTo(this)},draw:function(t){this.image.setColor&&this.image.setColor(this.r,this.g,this.b),this.superMethod("draw",t)}})}),phina.namespace(function(){phina.define("phina.particle2dx.ParticleGLLayer",{superClass:"phina.display.Layer",emitters:null,init:function(t){this.superInit(t),t={}.$safe(t,phina.particle2dx.ParticleGLLayer.defaults),this.emitters=[],this.domElement=t.domElement||document.createElement("canvas"),this.domElement.width=this.width*t.quality,this.domElement.height=this.height*t.quality;var i=this.domElement.getContext("webgl")||this.domElement.getContext("experimental-webgl");i.clearColor(0,0,0,0),i.enable(i.BLEND),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE,i.ONE,i.ONE),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);var e=mat4.create(),a=mat4.create(),n=(mat4.create(),mat4.create());mat4.ortho(e,0,this.width,this.height,0,.9,1.1),mat4.lookAt(a,[0,0,1],[0,0,0],[0,1,0]),mat4.mul(n,e,a),this.gl=i,this.ext=phigl.Extensions.getInstancedArrays(i),this.vpMatrix=n},createEmitter:function(t){var i=phina.particle2dx.EmitterGL(t);return this.emitters.push(i),i.addChildTo(this),i.setup(this),i.on("removed",function(){this.emitters.erase(i)}.bind(this)),i},draw:function(t){var i=this.gl;i.clear(i.COLOR_BUFFER_BIT),this._drawParticles(),i.flush();var e=this.domElement;t.context.drawImage(e,0,0,e.width,e.height,-this.width*this.originX,-this.height*this.originY,this.width,this.height)},_drawParticles:function(){for(var t=0;t<this.emitters.length;t++)this.emitters[t].render(this)},_static:{defaults:{}}})});